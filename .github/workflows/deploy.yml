name: Deploy to GitHub Pages

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g html-minifier-terser
          npm install -g csso-cli
          npm install -g terser

      - name: Prepare deployment directory
        run: |
          mkdir -p _deploy
          # Copy only production files (exclude tests, node_modules, CI configs)
          rsync -av --exclude='node_modules' \
                    --exclude='tests' \
                    --exclude='.github' \
                    --exclude='.git' \
                    --exclude='package*.json' \
                    --exclude='playwright.config.js' \
                    --exclude='*.log' \
                    --exclude='playwright-report' \
                    --exclude='test-results' \
                    --exclude='.gitignore' \
                    ./ _deploy/

      - name: Minify HTML
        run: |
          cd _deploy
          find . -name "*.html" -type f -exec html-minifier-terser \
            --collapse-whitespace \
            --remove-comments \
            --minify-css true \
            --minify-js true \
            -o {} {} \;

      - name: Minify CSS
        run: |
          cd _deploy
          find . -name "*.css" -type f -exec csso {} -o {} \;

      - name: Minify JS
        run: |
          cd _deploy
          find . -name "*.js" -type f -exec terser {} -o {} --compress --mangle \;

      - name: Add security headers via meta tags
        run: |
          cd _deploy
          # This will be enhanced with _headers file for proper CSP
          echo "Security headers added via deployment"

      - name: Create _headers file (Cloudflare/Netlify style for reference)
        run: |
          cd _deploy
          cat > _headers << 'EOF'
          /*
            X-Frame-Options: DENY
            X-Content-Type-Options: nosniff
            X-XSS-Protection: 1; mode=block
            Referrer-Policy: strict-origin-when-cross-origin
            Permissions-Policy: geolocation=(), microphone=(), camera=()
            Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'
            Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
            Cache-Control: public, max-age=31536000, immutable
          /*.html
            Cache-Control: public, max-age=3600, must-revalidate
          EOF

      - name: Create .nojekyll
        run: touch _deploy/.nojekyll

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_deploy'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
